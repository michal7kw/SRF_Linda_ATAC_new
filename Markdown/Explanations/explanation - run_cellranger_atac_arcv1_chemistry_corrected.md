---
created: 2025-08-26T08:16
updated: 2025-08-26T08:16
---
# Explanation of `run_cellranger_atac_arcv1_chemistry_corrected.sh`

This document explains the corrected `run_cellranger_atac_arcv1_chemistry_corrected.sh` script, its data processing pipeline, and the expected data format for 10x Multiome ATAC + Gene Expression data.

## Script Purpose

The primary purpose of this script is to process 10x Genomics Multiome ATAC + Gene Expression (ARC-v1 chemistry) sequencing data using `cellranger-arc count`. It automates the steps required to set up the environment, prepare input files, and execute the `cellranger-arc` pipeline for multiple samples in a Slurm array job.

## Data Processing Pipeline

The corrected pipeline addresses several critical issues identified in the original script, primarily related to software compatibility and correct input file formatting for `cellranger-arc`.

Here's a breakdown of the pipeline steps:

1.  **Environment Setup and Configuration:**
    *   Sets up Slurm job parameters (job name, output/error logs, array tasks, CPU/memory allocation, time limit, partition).
    *   Defines paths to `cellranger-arc` executable, reference genome, raw data, processed data, output directory, and temporary directory.
    *   Initializes `CELLRANGER_COPY_MODE` and `CELLRANGER_USE_HARDLINKS` environment variables.

2.  **Barcode Whitelist Management:**
    *   Defines the directory and filename for the ARC-v1 specific ATAC barcode whitelist (`atac_737K-arc-v1.txt`).
    *   Checks if the whitelist file already exists. If not, it downloads the gzipped file from the specified URL and unzips it. This ensures the correct barcode whitelist is used for Multiome ATAC data, which is crucial for accurate cell calling.

3.  **Sample-Specific Processing (within Slurm array job):**
    *   The script is designed to run as a Slurm array job, processing each sample defined in the `SAMPLES` array.
    *   For each sample:
        *   A unique timestamp and ID are generated.
        *   Sample-specific FASTQ and local temporary directories are created.
        *   `LOCAL_TMP` is defined early to prevent "unbound variable" errors during cleanup.

4.  **Symbolic Link Creation for FASTQ Files:**
    *   Verifies the existence of raw FASTQ files (I1, R1, R2, R3) in the `DATA_DIR`.
    *   Creates symbolic links to these raw FASTQ files in a `FASTQ_DIR` within the `OUTPUT_DIR`. This step is crucial for organizing the input data in a format expected by `cellranger-arc`.
    *   Specifically, for R2 reads, it uses the 16bp extracted barcode file from `PROCESSED_DATA_DIR`, which is a pre-processing step for ARC-v1 chemistry.

5.  **`cellranger-arc` Execution:**
    *   Validates the `cellranger-arc` executable and the reference genome path.
    *   Calculates available memory for `cellranger-arc` based on Slurm allocation.
    *   **Generates a `libraries.csv` file dynamically:** This is a critical correction. Instead of relying on `--fastqs` and `--sample` arguments directly, `cellranger-arc count` for Multiome data requires a `libraries.csv` file.
        *   The `libraries.csv` includes two entries for each sample: one for "Chromatin Accessibility" (ATAC) and one for "Gene Expression" (GEX).
        *   The columns are `fastqs`, `sample`, and `library_type`.
        *   The `fastqs` column points to the `FASTQ_DIR` containing the symbolic links.
        *   The `sample` column uses the `SAMPLE` variable.
        *   The `library_type` is correctly set to `"Chromatin Accessibility"` for ATAC and `"Gene Expression"` for GEX.
    *   Executes the `cellranger-arc count` command with the generated `libraries.csv`, reference, and resource allocations.

6.  **Results Handling:**
    *   Checks the exit code of `cellranger-arc count` to determine success or failure.
    *   If successful, it creates a sample-specific results directory and copies essential `cellranger-arc` outputs (e.g., `web_summary.html`, `summary.csv`, `filtered_feature_bc_matrix.h5`, `atac_fragments.tsv.gz`) to this directory.
    *   Verifies the existence of key output files.
    *   Copies the full output for reference.

7.  **Cleanup:**
    *   A `cleanup` function is trapped to execute on script exit, ensuring temporary directories are removed upon successful completion or preserved for inspection if the job fails.

## Data Format

The script expects input FASTQ files to be organized and named according to 10x Genomics conventions, typically generated by `cellranger-arc mkfastq` or `bcl2fastq`.

*   **Input FASTQ Files:**
    *   Located in `DATA_DIR` (for raw reads) and `PROCESSED_DATA_DIR` (for 16bp R2 barcode).
    *   Naming convention: `[SAMPLE_NAME]_[READ_TYPE]_001.fastq.gz` (e.g., `R26-Nestin-Mut-adult_R1_001.fastq.gz`).
    *   `READ_TYPE` includes `I1`, `R1`, `R2` (for 16bp extracted barcode), and `R3`.

*   **`libraries.csv` Format (generated by script):**
    *   This CSV file is crucial for `cellranger-arc count` and specifies the input libraries.
    *   **Header:** `fastqs,sample,library_type`
    *   **Example Entry:**
        ```
        fastqs,sample,library_type
        /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda/ATAC_data/cellranger_atac_arcv1_output_fixed/R26-Nestin-Mut-adult_fastq,R26-Nestin-Mut-adult,"Chromatin Accessibility"
        /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda/ATAC_data/cellranger_atac_arcv1_output_fixed/R26-Nestin-Mut-adult_fastq,R26-Nestin-Mut-adult,"Gene Expression"
        ```
    *   `fastqs`: Absolute path to the directory containing the demultiplexed FASTQ files for the sample.
    *   `sample`: The sample name (e.g., `R26-Nestin-Mut-adult`).
    *   `library_type`: Must be `"Chromatin Accessibility"` for ATAC libraries and `"Gene Expression"` for GEX libraries. These values are case-sensitive.

*   **Reference Genome:**
    *   The `REF` variable points to a `cellranger-arc`-compatible reference package (e.g., `/beegfs/scratch/ric.sessa/kubacki.michal/COMMONS/refdata-cellranger-arc-GRCm39-2024-A`). This reference must contain both ATAC-specific files (genome index, motifs) and gene expression-specific files (genome FASTA, GTF).

This corrected script provides a robust and compliant method for processing 10x Multiome ATAC + Gene Expression data using `cellranger-arc`.