=========================================
Processing ATAC sample: R26-Nestin-Ctrl-adult (FIXED VERSION)
Start time: Mon Sep  1 08:13:02 PM CEST 2025
=========================================
DEBUG: Configuration variables:
  SAMPLE: R26-Nestin-Ctrl-adult
  DATA_DIR: /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda/ATAC_data/DATA/nestin
  PROCESSED_DATA_DIR: /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda/ATAC_data/DATA/nestin_processed
  OUTPUT_DIR: /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda/ATAC_data/chromap_final_output
  REF_GENOME: /beegfs/scratch/ric.broccoli/kubacki.michal/SRF_MeCP2/SRF_MeCP2_CUTandTAG/DATA/mm10.fa
  CHROMAP_INDEX: /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda/ATAC_data/chromap_final_output/chromap_index/mm10.index
  THREADS: 16

DEBUG: Creating output directories...
DEBUG: Output directories created successfully
Step 1: Extracting barcodes from rightmost 16bp of R2...
DEBUG: R2 structure according to facility:
  [8bp SPACER][16bp 10x barcode] = 24bp total
  Extracting rightmost 16bp (positions 9-24)
DEBUG: Extracting rightmost 16bp from R2...
DEBUG: Barcode extraction completed
Using extracted barcodes from: /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda/ATAC_data/DATA/nestin_processed/R26-Nestin-Ctrl-adult_R2_rightmost16bp.fastq.gz
Step 2: Testing barcode extraction quality...
DEBUG: Checking whitelist files...
  Original whitelist: 736319 barcodes
  RC whitelist: 736319 barcodes
DEBUG: Testing extracted barcodes against whitelists...
DEBUG: Extracting test barcodes...
DEBUG: Extracted 10000 test barcodes
DEBUG: Sample barcode: GAATTNACTAATCACC
DEBUG: Barcode length: 16
DEBUG: Number of N's in sample barcode: 1
DEBUG: Testing whitelist orientations...
DEBUG: Using optimized matching approach to avoid hangs...
DEBUG: Testing original whitelist...
DEBUG: Testing reverse complement whitelist...
Whitelist matching results (tested on 1000 barcodes):
  Original: 0 / 1000 (0%)
  Reverse complement: 938 / 1000 (93.80%)
Using reverse complement whitelist
DEBUG: Best match rate: 93.80% (from 1000 test barcodes)
INFO: Good barcode match rate (93.80%)

Step 2.5: Validating read counts across files...
DEBUG: Counting reads in each file...
Read counts:
  R1 (genomic, forward): 235506914
  R3 (genomic, reverse): 235506914
  R2 (extracted barcodes): 235506914
âœ“ All file read counts match: 235506914 reads per file

Step 3: Running chromap alignment...
DEBUG: Proceeding with barcode error threshold: 1
DEBUG: Checking chromap availability...
DEBUG: chromap found: /beegfs/scratch/ric.sessa/kubacki.michal/conda/envs/alignment_two/bin/chromap
DEBUG: chromap version: 0.3.2-r518
DEBUG: Using existing chromap index: /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda/ATAC_data/chromap_final_output/chromap_index/mm10.index
DEBUG: Running chromap with the following parameters:
  Reference: /beegfs/scratch/ric.broccoli/kubacki.michal/SRF_MeCP2/SRF_MeCP2_CUTandTAG/DATA/mm10.fa
  Index: /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda/ATAC_data/chromap_final_output/chromap_index/mm10.index
  R1: /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda/ATAC_data/DATA/nestin/R26-Nestin-Ctrl-adult_R1_001.fastq.gz
  R2: /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda/ATAC_data/DATA/nestin/R26-Nestin-Ctrl-adult_R3_001.fastq.gz
  Barcode: /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda/ATAC_data/DATA/nestin_processed/R26-Nestin-Ctrl-adult_R2_rightmost16bp.fastq.gz (rightmost 16bp from R2)
  Whitelist: /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda/ATAC_data/barcode_whitelists/atac_737K-arc-v1_rc.txt
  Barcode error threshold: 1
  Expected match rate: 93.80%
DEBUG: Skipping chromap alignment, fragments file already exists.

Step 4: Processing fragments...
DEBUG: Skipping fragment indexing, index file already exists.

Step 5: Generating statistics...
Fragment statistics:
  Total fragments: 163409523
  Unique barcodes: 458921
  Valid whitelist barcodes: 1
  Fragments in cells: 163409523
  Fraction in cells: 1.0000

DEBUG: Step 6 - Calling peaks with MACS2...
DEBUG: Checking for genome sizes file...
DEBUG: Genome sizes file already exists: 66 chromosomes
DEBUG: Converting fragments to reads for peak calling...
DEBUG: Using bedClip for coordinate clipping
DEBUG: Reads file created successfully
DEBUG: Number of reads: 325443082
DEBUG: Checking for MACS2...
ERROR: MACS2 not found. Please install MACS2 for peak calling
DEBUG: You can install with: pip install MACS2
